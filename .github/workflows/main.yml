name: ğŸ–¥ï¸ RDP â€¢ Windows â€¢ Clean & Simple

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
    # ==========================================================
    # ğŸ” ENABLE RDP
    # ==========================================================
    - name: ğŸ” Enable RDP & Firewall
      run: |
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name "fDenyTSConnections" -Value 0 -Force

        netsh advfirewall firewall delete rule name="RDP-3389" 2>$null
        netsh advfirewall firewall add rule name="RDP-3389" `
          dir=in action=allow protocol=TCP localport=3389

        Restart-Service TermService -Force

    # ==========================================================
    # ğŸ‘¤ USER: WIN (FIXED PASSWORD)
    # ==========================================================
    - name: ğŸ‘¤ Create RDP User
      run: |
        $User = "WIN"
        $Pass = "Win@123"
        $Secure = ConvertTo-SecureString $Pass -AsPlainText -Force

        if (Get-LocalUser -Name $User -ErrorAction SilentlyContinue) {
          Set-LocalUser -Name $User -Password $Secure
        } else {
          New-LocalUser -Name $User -Password $Secure -AccountNeverExpires
          Add-LocalGroupMember Administrators $User
          Add-LocalGroupMember "Remote Desktop Users" $User
        }

        echo "RDP_USER=$User" >> $env:GITHUB_ENV
        echo "RDP_PASS=$Pass" >> $env:GITHUB_ENV

    # ==========================================================
    # ğŸ§¼ REMOVE SERVER / EVALUATION WATERMARK (SUPPORTED WAY)
    # ==========================================================
    - name: ğŸ§¼ Clean Desktop Watermark
      run: |
        reg add "HKCU\Control Panel\Desktop" `
          /v "PaintDesktopVersion" /t REG_DWORD /d 0 /f

    # ==========================================================
    # ğŸŒ INSTALL & CONNECT TAILSCALE
    # ==========================================================
    - name: ğŸŒ Install Tailscale
      run: |
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi `
          -OutFile $env:TEMP\tailscale.msi
        Start-Process msiexec.exe `
          -ArgumentList "/i", "`"$env:TEMP\tailscale.msi`"", "/quiet", "/norestart" `
          -Wait

    - name: ğŸ”— Connect Tailscale
      run: |
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
          --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
          --hostname=gh-rdp-$env:GITHUB_RUN_ID

        $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

    # ==========================================================
    # ğŸŸ¢ READY + KEEP ALIVE
    # ==========================================================
    - name: ğŸŸ¢ RDP READY
      run: |
        Write-Host "=================================="
        Write-Host "ğŸ–¥ï¸  RDP IS READY"
        Write-Host "ğŸŒ ADDRESS : $env:TAILSCALE_IP"
        Write-Host "ğŸ‘¤ USER    : WIN"
        Write-Host "ğŸ”‘ PASS    : Win@123"
        Write-Host "=================================="

        while ($true) {
          Start-Sleep -Seconds 300
        }
